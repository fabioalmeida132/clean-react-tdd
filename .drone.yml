kind: pipeline
type: docker
name: default

steps:
  - name: install-deps
    volumes:
      - name: cypress-cache
        path: /root/.cache/Cypress
    image: node:21
    commands:
      - yarn install
    cache:
      key: node-modules-cache
      paths:
        - node_modules

  - name: start-application
    volumes:
      - name: cypress-cache
        path: /root/.cache/Cypress
    image: node:21
    commands:
      - yarn start &
      - sleep 5
      - curl --retry 5 --retry-delay 5 --retry-connrefused http://localhost:8080 || echo "Failed to connect to server"
      - curl http://localhost:8080
      - echo "Server logs:"
      - yarn logs
    environment:
      PORT: 8080
    depends_on:
      - install-deps

  - name: test
    volumes:
      - name: cypress-cache
        path: /root/.cache/Cypress
    image: cypress/base:13.3.0
    commands:
      - yarn run cypress run
    environment:
      CYPRESS_baseUrl: http://localhost:8080
    depends_on:
      - start-application

volumes:
  - name: cypress-cache
    host:
      path: /tmp/cypress-cache
